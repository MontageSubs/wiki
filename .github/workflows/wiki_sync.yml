name: "Publish: MontageSubs Encyclopedia"

on:
  workflow_dispatch: 

permissions:
  contents: write

jobs:
  sync-history:
    name: Replay Wiki History and Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Infra Branch
        uses: actions/checkout@v4
        with:
          ref: infra
          fetch-depth: 0

      - name: Setup Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: 3.x

      - name: Install MkDocs Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs-material

      - name: Core Logic: Wiki History Replay
        id: replay
        run: |
          # Initialize Sync Metadata
          CONFIG_DIR="config"
          COMMIT_FILE="$CONFIG_DIR/wiki_last_commit"
          mkdir -p "$CONFIG_DIR"
          
          if [ -f "$COMMIT_FILE" ]; then
            LAST_SYNC_SHA=$(cat "$COMMIT_FILE")
          else
            LAST_SYNC_SHA=""
          fi
          
          # Clone Remote Wiki Source
          git clone https://github.com/MontageSubs/wiki.wiki.git wiki_git
          cd wiki_git
          
          # Compute Commit Range
          if [ -z "$LAST_SYNC_SHA" ]; then
            COMMITS=$(git rev-list --reverse HEAD)
          else
            COMMITS=$(git rev-list --reverse $LAST_SYNC_SHA..HEAD)
          fi

          if [ -z "$COMMITS" ]; then
            echo "Sync Status: Up-to-date."
            echo "changed=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Begin Atomic Replay Loop
          for SHA in $COMMITS; do
            echo "Replaying Commit: $SHA"
            
            # Extract Original Metadata for Identity Impersonation
            AUTHOR_NAME=$(git show -s --format='%an' $SHA)
            AUTHOR_EMAIL=$(git show -s --format='%ae' $SHA)
            AUTHOR_DATE=$(git show -s --format='%ad' $SHA)
            COMMIT_MSG=$(git show -s --format='%s' $SHA)
            
            git checkout $SHA
            cd .. 
            
            # Workspace Maintenance: Preserve '/site' directory while cleaning workspace
            mkdir -p docs
            find docs -mindepth 1 -not -path 'docs/site*' -delete
            
            # Synchronization: Migrate Wiki Content to Docs Directory
            cp -r wiki_git/* docs/
            rm -rf docs/.git
            
            # Syntax Transformation: Convert Wiki-style brackets to Standard Markdown
            find docs -name "*.md" -exec sed -i -E 's/\[\[([^]|]+)\|([^]]+)\]\]/[\2](\1.md)/g' {} +
            find docs -name "*.md" -exec sed -i -E 's/\[\[([^]|]+)\]\]/[\1](\1.md)/g' {} +
            
            # Route Optimization: Align Wiki 'Home' with MkDocs Index
            if [ -f docs/Home.md ]; then mv docs/Home.md docs/index.md; fi
            
            # Record Checkpoint
            echo "$SHA" > "$COMMIT_FILE"
            git add docs "$COMMIT_FILE"
            
            # Commit Sign-off: Impersonate original author and committer
            export GIT_AUTHOR_NAME="$AUTHOR_NAME"
            export GIT_AUTHOR_EMAIL="$AUTHOR_EMAIL"
            export GIT_AUTHOR_DATE="$AUTHOR_DATE"
            export GIT_COMMITTER_NAME="$AUTHOR_NAME"
            export GIT_COMMITTER_EMAIL="$AUTHOR_EMAIL"
            export GIT_COMMITTER_DATE="$AUTHOR_DATE"
            
            git commit --allow-empty \
              -m "wiki: $COMMIT_MSG" \
              -m "Original Wiki Hash: $SHA"
            
            unset GIT_AUTHOR_NAME GIT_AUTHOR_EMAIL GIT_AUTHOR_DATE
            unset GIT_COMMITTER_NAME GIT_COMMITTER_EMAIL GIT_COMMITTER_DATE
            
            cd wiki_git 
          done
          
          echo "changed=true" >> $GITHUB_OUTPUT

      - name: Persistent Storage: Push Replayed Branch
        if: steps.replay.outputs.changed == 'true'
        run: |
          git push origin infra

      - name: Production Deployment: MkDocs Build & Gh-Pages Update
        if: steps.replay.outputs.changed == 'true'
        run: |
          python -m mkdocs gh-deploy --force --clean