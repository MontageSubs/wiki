name: "Publish: MontageSubs Encyclopedia"

on:
  workflow_dispatch: # 手动触发

permissions:
  contents: write

jobs:
  sync-history:
    name: Replay Wiki History and Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Infra
        uses: actions/checkout@v4
        with:
          ref: infra
          fetch-depth: 0

      # 必须添加 Python 环境，否则无法运行 mkdocs 部署
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.x

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs-material

      - name: Replay Wiki History
        id: replay
        run: |
          # 1. 自动创建配置目录
          CONFIG_DIR="config"
          COMMIT_FILE="$CONFIG_DIR/wiki_last_commit"
          mkdir -p "$CONFIG_DIR"
          
          # 2. 读取上次同步的断点
          if [ -f "$COMMIT_FILE" ]; then
            LAST_SYNC_SHA=$(cat "$COMMIT_FILE")
          else
            LAST_SYNC_SHA=""
          fi

          # 3. 克隆并获取 Wiki 历史
          git clone https://github.com/MontageSubs/wiki.wiki.git wiki_git
          cd wiki_git
          
          if [ -z "$LAST_SYNC_SHA" ]; then
            COMMITS=$(git rev-list --reverse HEAD)
          else
            COMMITS=$(git rev-list --reverse $LAST_SYNC_SHA..HEAD)
          fi

          if [ -z "$COMMITS" ]; then
            echo "No new commits to replay."
            echo "changed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 4. 逐条重演历史
          for SHA in $COMMITS; do
            echo "Processing wiki commit: $SHA"
            
            # 提取原作者元数据
            AUTHOR_NAME=$(git show -s --format='%an' $SHA)
            AUTHOR_EMAIL=$(git show -s --format='%ae' $SHA)
            AUTHOR_DATE=$(git show -s --format='%ad' $SHA)
            COMMIT_MSG=$(git show -s --format='%s' $SHA)
            
            # 切换到对应的历史版本
            git checkout $SHA
            
            cd .. # 回到仓库根目录
            
            # 搬运内容到 docs
            rm -rf docs
            mkdir docs
            cp -r wiki_git/* docs/
            rm -rf docs/.git
            
            # 转换 [[link]] 语法
            find docs -name "*.md" -exec sed -i -E 's/\[\[([^]|]+)\|([^]]+)\]\]/[\2](\1.md)/g' {} +
            find docs -name "*.md" -exec sed -i -E 's/\[\[([^]|]+)\]\]/[\1](\1.md)/g' {} +
            
            # 首页适配
            if [ -f docs/Home.md ]; then mv docs/Home.md docs/index.md; fi

            # 更新同步记录文件
            echo "$SHA" > "$COMMIT_FILE"
            
            # 提交到 infra 分支
            git add docs "$COMMIT_FILE"
            
            # 身份伪装：让 Committer 也是原作者
            export GIT_AUTHOR_NAME="$AUTHOR_NAME"
            export GIT_AUTHOR_EMAIL="$AUTHOR_EMAIL"
            export GIT_AUTHOR_DATE="$AUTHOR_DATE"
            export GIT_COMMITTER_NAME="$AUTHOR_NAME"
            export GIT_COMMITTER_EMAIL="$AUTHOR_EMAIL"
            export GIT_COMMITTER_DATE="$AUTHOR_DATE"
            
            # 干净的提交：标题不含 Hash，Hash 隐藏在详细描述中
            git commit --allow-empty \
              -m "wiki: $COMMIT_MSG" \
              -m "Original Wiki Hash: $SHA"
            
            # 清理环境变量
            unset GIT_AUTHOR_NAME GIT_AUTHOR_EMAIL GIT_AUTHOR_DATE
            unset GIT_COMMITTER_NAME GIT_COMMITTER_EMAIL GIT_COMMITTER_DATE
            
            cd wiki_git # 继续循环
          done
          
          echo "changed=true" >> $GITHUB_OUTPUT

      - name: Push Replayed History
        if: steps.replay.outputs.changed == 'true'
        run: |
          git push origin infra

      - name: Deploy to GitHub Pages
        if: steps.replay.outputs.changed == 'true'
        run: |
          # 只要有内容更新，立即原地构建并发布
          python -m mkdocs gh-deploy --force --clean
