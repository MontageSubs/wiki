name: "Publish: MontageSubs Encyclopedia"

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-history:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Infra
        uses: actions/checkout@v4
        with:
          ref: infra
          fetch-depth: 0 # 获取完整历史以进行增量比对

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.x

      - name: Install Dependencies
        run: pip install mkdocs-material

      - name: Replay Wiki History
        id: replay
        run: |
          # 配置 Git 基础信息（用于 Committer 身份）
          git config --local user.email "action@github.com"
          git config --local user.name "Wiki Replay Bot"

          # 1. 自动创建配置目录
          CONFIG_DIR="config"
          COMMIT_FILE="$CONFIG_DIR/wiki_last_commit"
          mkdir -p "$CONFIG_DIR"
          
          # 2. 读取上次同步的断点
          if [ -f "$COMMIT_FILE" ]; then
            LAST_SYNC_SHA=$(cat "$COMMIT_FILE")
          else
            LAST_SYNC_SHA=""
          fi

          # 3. 克隆并获取 Wiki 历史
          git clone https://github.com/MontageSubs/wiki.wiki.git wiki_git
          cd wiki_git
          
          if [ -z "$LAST_SYNC_SHA" ]; then
            # 第一次运行，获取所有历史
            COMMITS=$(git rev-list --reverse HEAD)
          else
            # 获取自上次同步以来的新提交
            COMMITS=$(git rev-list --reverse $LAST_SYNC_SHA..HEAD)
          fi

          if [ -z "$COMMITS" ]; then
            echo "No new commits to replay."
            echo "changed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 4. 逐条重演历史
          for SHA in $COMMITS; do
            echo "Processing wiki commit: $SHA"
            
            # 提取原作者元数据
            AUTHOR_NAME=$(git show -s --format='%an' $SHA)
            AUTHOR_EMAIL=$(git show -s --format='%ae' $SHA)
            AUTHOR_DATE=$(git show -s --format='%ad' $SHA)
            COMMIT_MSG=$(git show -s --format='%s' $SHA)
            
            # 切换到对应的历史版本
            git checkout $SHA
            
            cd .. # 回到仓库根目录
            
            # 搬运内容到 docs
            rm -rf docs
            mkdir docs
            cp -r wiki_git/* docs/
            rm -rf docs/.git
            
            # 转换 [[link]] 语法
            find docs -name "*.md" -exec sed -i -E 's/\[\[([^]|]+)\|([^]]+)\]\]/[\2](\1.md)/g' {} +
            find docs -name "*.md" -exec sed -i -E 's/\[\[([^]|]+)\]\]/[\1](\1.md)/g' {} +
            
            # 首页适配
            if [ -f docs/Home.md ]; then mv docs/Home.md docs/index.md; fi

            # 更新同步记录文件
            echo "$SHA" > "$COMMIT_FILE"
            
            # 以原作者名义提交到 infra 分支
            git add docs "$COMMIT_FILE"
            GIT_AUTHOR_NAME="$AUTHOR_NAME" \
            GIT_AUTHOR_EMAIL="$AUTHOR_EMAIL" \
            GIT_COMMITTER_NAME="Wiki Bot" \
            GIT_COMMITTER_EMAIL="action@github.com" \
            git commit --date "$AUTHOR_DATE" -m "wiki: $COMMIT_MSG (from wiki $SHA)"
            
            cd wiki_git # 回到 wiki 目录继续循环
          done
          
          echo "changed=true" >> $GITHUB_OUTPUT

      - name: Push Replayed History
        if: steps.replay.outputs.changed == 'true'
        run: |
          # 推送回 infra 分支，GitHub 会自动识别这些 Commit 的作者
          git push origin infra

      - name: Deploy to GitHub Pages
        if: steps.replay.outputs.changed == 'true'
        run: |
          python -m mkdocs gh-deploy --force --clean
