{# --- 1. 配置区 --- #}
{% set repo_url = "https://github.com/MontageSubs/wiki" %}
{% set file_path = page.file.src_uri %}
{% set wiki_page = file_path | replace("index.md", "Home") | replace(".md", "") %}
{% set target_edit_url = repo_url ~ "/wiki/" ~ wiki_page ~ "/_edit" %}
{% set login_edit_url = "https://github.com/login?return_to=" ~ (target_edit_url | urlencode) %}

{# --- 2. HTML 结构区 --- #}
{# 移除自定义 float，直接嵌套在主题默认的 action 容器中 #}
<div class="md-content__articles action-wrapper" data-search-ignore>
  
  <div class="action-edit-group">
    {# 编辑按钮：使用官方 include 方式，解决色差 #}
    <a href="{{ login_edit_url }}" 
       id="action-edit-trigger" 
       title="贡献与编辑" 
       data-original-title="贡献与编辑"
       class="md-content__button md-icon">
      {% include ".icons/material/file-document-edit-outline.svg" %}
    </a>

    {# 弹出菜单 #}
    <div id="action-popup" class="gh-popup-container" hidden aria-hidden="true">
      <div class="gh-popup-arrow"></div>
      <div class="gh-popup-box">
        <div class="gh-popup-header">
          <strong>参与百科贡献</strong>
          <p>一本众创、共建、同享的字幕百科</p>
        </div>
        <div class="gh-popup-body">
          <a href="{{ login_edit_url }}" class="gh-btn-primary">
            使用 GitHub 账号编辑
          </a>
          
          <ul class="gh-links-list">
            <li>
              <a href="https://montagesubs.github.io/wiki/百科贡献指南">
                {% include ".icons/material/book-open-variant.svg" %}
                <span>百科语法指南</span>
              </a>
            </li>
            <li>
              <a href="https://montagesubs.github.io/wiki/GitHub-帮助指南">
                {% include ".icons/material/github.svg" %}
                <span>GitHub 帮助指南</span>
              </a>
            </li>
            <li>
              <a href="https://montagesubs.github.io/wiki/贡献指南">
                {% include ".icons/material/heart-outline.svg" %}
                <span>贡献指南</span>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  {# 历史按钮：同样使用官方 include #}
  <a href="{{ repo_url }}/wiki/{{ wiki_page }}/_history" 
     title="查看编辑历史" 
     class="md-content__button md-icon">
    {% include ".icons/material/history.svg" %}
  </a>
</div>

{# --- 3. CSS 样式区 --- #}
<style>
  /* 1. 位置优化：不再硬编码 top/margin，继承主题 L1 层级 */
  .action-wrapper {
    display: flex;
    align-items: center;
    gap: 4px;
    /* 保持与主题默认 edit 按钮位置一致 */
  }

  .action-edit-group { position: relative; display: flex; align-items: center; }

  /* 2. 颜色一致性：强制继承主题文字颜色，消除色差 */
  .action-wrapper .md-content__button {
    color: var(--md-default-fg-color) !important;
    opacity: 0.7;
  }
  .action-wrapper .md-content__button svg {
    width: 1.2rem;
    height: 1.2rem;
    fill: currentColor; /* 确保颜色受 CSS 控制 */
  }

  /* 3. GitHub 按钮颜色：根据你的要求精准定制 */
  :root {
    --gh-btn-bg: #1f883d;
    --gh-btn-hover: #1c8139;
  }
  [data-md-color-scheme="slate"] {
    --gh-btn-bg: #238636;
    --gh-btn-hover: #29903b;
  }

  .gh-btn-primary {
    display: block; width: 100%; box-sizing: border-box;
    background-color: var(--gh-btn-bg);
    color: #ffffff !important;
    text-align: center; padding: 8px; border-radius: 6px;
    font-size: 0.7rem; font-weight: 600; text-decoration: none;
    transition: background-color 0.2s;
  }
  .gh-btn-primary:hover { background-color: var(--gh-btn-hover); }

  /* 4. 菜单文字排版美化 */
  .gh-links-list {
    margin: 12px 0 0; padding: 8px 0 0; list-style: none;
    border-top: 1px solid var(--md-divider-color);
  }
  .gh-links-list li a {
    display: flex; align-items: center; gap: 8px;
    padding: 6px 4px; border-radius: 4px;
    font-size: 0.7rem; color: var(--md-default-fg-color);
    text-decoration: none; transition: background 0.2s;
  }
  .gh-links-list li a:hover {
    background-color: var(--md-default-bg-color--lightest);
    color: var(--md-accent-fg-color);
  }
  .gh-links-list li a svg {
    width: 14px; height: 14px; opacity: 0.6;
    fill: currentColor;
  }

  /* 5. 弹窗与三角微调 */
  .gh-popup-container {
    position: absolute; top: 100%; right: -8px; 
    margin-top: 12px; width: 240px; z-index: 20;
    filter: drop-shadow(0 4px 12px rgba(0,0,0,0.15));
  }
  .gh-popup-arrow {
    position: absolute; top: -5px; 
    right: 21px; /* 向左再移动 3px 以对齐编辑按钮中心 */
    width: 10px; height: 10px;
    background: var(--md-default-bg-color);
    border-top: 1px solid var(--md-divider-color);
    border-left: 1px solid var(--md-divider-color);
    transform: rotate(45deg);
  }
  .gh-popup-box {
    background: var(--md-default-bg-color);
    border: 1px solid var(--md-divider-color);
    border-radius: 8px; overflow: hidden;
  }
  .gh-popup-header { padding: 12px; background: var(--md-default-bg-color--lightest); }
  .gh-popup-header strong { font-size: 0.75rem; }
  .gh-popup-header p { font-size: 0.6rem; opacity: 0.8; margin: 2px 0 0; }
  .gh-popup-body { padding: 12px; }

  /* 移动端保护 */
  @media screen and (max-width: 400px) {
    .gh-popup-container { right: -40px; max-width: 80vw; }
    .gh-popup-arrow { right: 53px; }
  }
</style>

{# --- 4. JS 交互 (逻辑同前，增强了鲁棒性) --- #}
<script>
(function() {
  const trigger = document.getElementById('action-edit-trigger');
  const popup = document.getElementById('action-popup');
  const drawer = document.getElementById('__drawer');
  
  const togglePopup = (show) => {
    popup.hidden = !show;
    if(show) {
      trigger.removeAttribute('title');
      trigger.removeAttribute('aria-label');
    } else {
      trigger.setAttribute('title', trigger.getAttribute('data-original-title'));
    }
  };

  trigger?.addEventListener('click', (e) => {
    if (drawer?.checked) return; // 汉堡菜单优先
    e.preventDefault(); e.stopPropagation();
    togglePopup(popup.hidden);
  });

  document.addEventListener('click', () => togglePopup(false));
  popup?.addEventListener('click', (e) => e.stopPropagation());
})();
</script>
