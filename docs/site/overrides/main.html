{% extends "base.html" %}

{% block content %}
  {# 1. 业务逻辑变量定义 #}
  {% set repo_url = "https://github.com/MontageSubs/wiki/wiki" %}
  {% set file_path = page.file.src_uri %}
  {% set wiki_page = file_path | replace("index.md", "Home") | replace(".md", "") %}
  {% set target_edit_url = repo_url ~ "/" ~ wiki_page ~ "/_edit" %}
  {% set login_edit_url = "https://github.com/login?return_to=" ~ (target_edit_url | urlencode) %}

  {# 2. 右上角功能导航栏 #}
  <nav class="custom-edit-nav" style="pointer-events: none;">
    <a href="{{ login_edit_url }}" id="edit-btn" title="贡献与编辑" class="md-content__button md-icon" style="color: var(--md-icon-fg-color); pointer-events: auto;">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"></path></svg>
    </a>
    <a href="{{ repo_url }}/{{ wiki_page }}/_history" title="查看编辑历史" class="md-content__button md-icon" style="color: var(--md-icon-fg-color); pointer-events: auto;">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5 5 5 0 0 1 5-5 5 5 0 0 1 5 5 5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5z"></path></svg>
    </a>
  </nav>

  {# 3. 交互弹窗 #}
  <dialog id="edit-dialog" class="custom-edit-dialog">
    <div style="text-align: center; margin-bottom: 20px;">
      <h3 style="margin: 0; font-size: 1.2rem; font-weight: 700;">参与百科贡献</h3>
      <p style="font-size: 0.8rem; color: var(--md-default-fg-color--light); margin-top: 8px;">一本众创、共建、同享的字幕百科</p>
    </div>
    <div style="display: flex; flex-direction: column; gap: 10px;">
      <a href="{{ login_edit_url }}" class="gh-btn-primary">使用 GitHub 账号编辑</a>
    </div>
    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--md-divider-color);">
      <ul style="font-size: 0.8rem; padding-left: 1.2rem; line-height: 2; margin: 0;">
        <li><a href="{{ '百科语法指南' | url }}" style="color: var(--md-typeset-a-color);">百科语法指南</a></li>
        <li><a href="{{ 'GitHub-帮助指南' | url }}" style="color: var(--md-typeset-a-color);">GitHub 帮助指南</a></li>
        <li><a href="{{ '贡献指南' | url }}" style="color: var(--md-typeset-a-color);">贡献指南</a></li>
      </ul>
    </div>
    <button onclick="this.closest('dialog').close()" class="gh-btn-secondary">取消</button>
  </dialog>

  <style>
    /* Dark Mode (Slate) 对取消按钮的适配 */
    [data-md-color-scheme="slate"] .gh-btn-secondary {
         background-color: #212830;
         color: #adbac7 !important;
         border-color: #444c56;
    }
  </style>

  <script>
    document.getElementById('edit-btn').addEventListener('click', function(e) {
      e.preventDefault();
      document.getElementById('edit-dialog').showModal();
    });
  </script>

  {{ super() }}
{% endblock %}

{% block footer %}
  <footer class="md-footer">
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        {% include "partials/copyright.html" %}
      </div>
    </div>
  </footer>
{% endblock %}
