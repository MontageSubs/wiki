{# ========================================================================== #}
{# 1. 变量定义 #}
{# ========================================================================== #}
{% set repo_url = "https://github.com/MontageSubs/wiki/wiki" %}
{% set file_path = page.file.src_uri %}
{% set wiki_page = file_path | replace("index.md", "Home") | replace(".md", "") %}
{# 编辑链接 #}
{% set target_edit_url = repo_url ~ "/" ~ wiki_page ~ "/_edit" %}
{% set login_edit_url = "https://github.com/login?return_to=" ~ (target_edit_url | urlencode) %}
{# 历史链接 #}
{% set history_url = repo_url ~ "/" ~ wiki_page ~ "/_history" %}

{# SVG 图标路径 (提取复用) #}
{% set icon_edit = "M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z" %}
{% set icon_history = "M12 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5 5 5 0 0 1 5-5 5 5 0 0 1 5 5 5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5z" %}

{# ========================================================================== #}
{# 2. 导航栏 (只写一套代码，同时兼容 JS 和 No-JS) #}
{# ========================================================================== #}
<nav class="md-content__articles custom-actions-nav">
  
  {# 按钮 A: 编辑 (默认是跳转链接) #}
  <a href="{{ login_edit_url }}" id="action-edit" title="贡献与编辑" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="{{ icon_edit }}"></path></svg>
  </a>

  {# 按钮 B: 历史 (总是跳转链接) #}
  <a href="{{ history_url }}" title="查看编辑历史" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="{{ icon_history }}"></path></svg>
  </a>

</nav>

{# ========================================================================== #}
{# 3. 弹窗组件 #}
{# ========================================================================== #}
<dialog id="edit-dialog" class="custom-dialog">
  <div class="dialog-header">
    <h3>参与百科贡献</h3>
    <p>一本众创、共建、同享的字幕百科</p>
  </div>
  
  <div class="dialog-body">
    <a href="{{ login_edit_url }}" class="gh-btn-primary">
      使用 GitHub 账号编辑
    </a>
  </div>

  <div class="dialog-footer">
    <ul>
      <li><a href="{{ repo_url }}/百科语法指南">百科语法指南</a></li>
      <li><a href="{{ repo_url }}/GitHub-帮助指南">GitHub 帮助指南</a></li>
      <li><a href="{{ repo_url }}/贡献指南">贡献指南</a></li>
    </ul>
  </div>

  <button id="close-dialog-btn" class="gh-btn-secondary">取消</button>
</dialog>

{# ========================================================================== #}
{# 4. 样式 #}
{# ========================================================================== #}
<style>
  /* 容器定位 */
  .custom-actions-nav {
    float: right;
    display: flex;
    gap: 8px;
    position: relative;
    pointer-events: none; /* 让鼠标穿透容器 */
  }
  
  /* 恢复按钮点击 */
  .custom-actions-nav .md-content__button {
    color: var(--md-icon-fg-color);
    pointer-events: auto; 
    cursor: pointer;
  }

  /* 弹窗样式 */
  .custom-dialog {
    border: 1px solid var(--md-divider-color);
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    width: 90%;
    max-width: 360px;
    background: var(--md-default-bg-color);
    color: var(--md-default-fg-color);
  }
  .dialog-header { text-align: center; margin-bottom: 20px; }
  .dialog-header h3 { margin: 0; font-size: 1.2rem; font-weight: 700; }
  .dialog-header p { font-size: 0.8rem; opacity: 0.7; margin-top: 8px; }
  
  .dialog-body a { text-decoration: none; display: block; text-align: center; padding: 12px; border-radius: 6px; font-weight: 600; font-size: 0.9rem; border: 1px solid rgba(27,31,35,0.15); }
  
  .dialog-footer { margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--md-divider-color); }
  .dialog-footer ul { font-size: 0.8rem; padding-left: 1.2rem; line-height: 2; margin: 0; }
  .dialog-footer a { color: var(--md-typeset-a-color); text-decoration: none; }

  /* 按钮颜色 */
  .gh-btn-primary { background-color: #1f883d; color: #fff !important; }
  .gh-btn-primary:hover { background-color: #1a7a35; }
  
  .gh-btn-secondary { margin-top: 20px; width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--md-divider-color); cursor: pointer; background-color: #f6f8fa; color: #24292f; }
  .gh-btn-secondary:hover { background-color: #f3f4f6; }

  [data-md-color-scheme="slate"] .gh-btn-primary { background-color: #238636; }
  [data-md-color-scheme="slate"] .gh-btn-primary:hover { background-color: #2ea043; }
  [data-md-color-scheme="slate"] .gh-btn-secondary { background-color: #212830; color: #adbac7; border-color: #444c56; }
  [data-md-color-scheme="slate"] .gh-btn-secondary:hover { background-color: #262c36; border-color: #768390; }
</style>

{# ========================================================================== #}
{# 5. 脚本 (渐进增强逻辑) #}
{# ========================================================================== #}
<script>
  (function() {
    var editBtn = document.getElementById('action-edit');
    var editDialog = document.getElementById('edit-dialog');
    var closeBtn = document.getElementById('close-dialog-btn');
    
    // 仅当 JS 正常加载，且找到相关元素时，才进行拦截
    if (editBtn && editDialog && closeBtn) {
      
      // 1. 拦截编辑按钮点击
      editBtn.addEventListener('click', function(e) {
        // 只有这里我们阻止默认跳转，改为打开弹窗
        // 如果这行代码因为JS被禁用而不执行，浏览器会自动跳转 href 链接
        e.preventDefault(); 
        editDialog.showModal();
      });

      // 2. 绑定取消按钮
      closeBtn.addEventListener('click', function() {
        editDialog.close();
      });

      // 3. 点击弹窗外部也可关闭 (可选优化)
      editDialog.addEventListener('click', function(e) {
        if (e.target === editDialog) {
          editDialog.close();
        }
      });
    }
  })();
</script>
